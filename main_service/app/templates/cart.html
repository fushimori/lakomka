<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link rel="stylesheet" href="/static/cart.css">
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const email = "{{ email }}"; // Получаем email из шаблона

            try {
                // Шаг 1: Получаем user_id по email
                console.log("DEBUG: Email is:", email);
                const userIdResponse = await fetch(`http://localhost:8001/get_user_id?email=${email}`);
                if (!userIdResponse.ok) {
                    throw new Error('Failed to fetch user ID');
                }
                const { user_id } = await userIdResponse.json();
                console.log("DEBUG: User ID is:", user_id);

                // Шаг 2: Получаем товары корзины по user_id
                const cartResponse = await fetch(`http://localhost:8004/cart/${user_id}`);
                if (!cartResponse.ok) {
                    throw new Error('Failed to fetch cart items');
                }
                const cartItems = await cartResponse.json();

                // Шаг 3: Получаем информацию о каждом товаре по его ID
                for (let item of cartItems) {
                    const productResponse = await fetch(`http://localhost:8003/api/get_product?id=${item.product_id}`);
                    if (productResponse.ok) {
                        const product = await productResponse.json();
                        item.product_name = product.name;
                        item.product_image = product.image_url || 'https://via.placeholder.com/400'; // предполагается, что картинка товара доступна по полю image_url
                    }
                }

                // Шаг 4: Отображаем товары на странице
                renderCart(cartItems);
            } catch (error) {
                console.error('Error:', error);
                renderCart([]);
            }
        });

        function renderCart(cartItems) {
            const cartContainer = document.getElementById('cartContainer');
            cartContainer.innerHTML = `
                <header>
                    <div>
                        <h1>Lakomka</h1>
                    </div>
                    <div>
                        <a href="/">Home</a>
                        <a href="/logout">Log out</a>
                    </div>
                </header>
                <div class="cart-info">
                    <h1>Your Cart</h1>
                </div>

                <div class="cart-items">
                    <div class="items-grid">
                        ${cartItems.length > 0 ? `
                            ${cartItems.map(item => `
                                <div class="item-card">
                                    <p><strong>Product Name:</strong> ${item.product_name}</p>
                                    <img src="${item.product_image}" alt="${item.product_name}" class="product-image"/>
                                    <p><strong>Quantity:</strong> ${item.quantity}</p>
                                    <button class="delete-button" onclick="deleteItem(${item.product_id}, 'YOUR_TOKEN_HERE')">Delete</button>
                                </div>
                            `).join('')}
                        ` : '<p class="empty-message">EMPTY</p>'}
                    </div>
                </div>
            `;
        }

        async function deleteItem(productId, token) {
            try {
                const token = "{{ token }}"
                console.log("JWT Token:", token);
                const response = await fetch(`http://localhost:8004/cart/delete?product_id=${productId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to delete item');
                }
                // После успешного удаления обновляем корзину
<!--                alert('Item deleted successfully');-->
                location.reload(); // Перезагружаем страницу, чтобы обновить список товаров
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Failed to delete item');
            }
        }
    </script>
</head>
<body>
    <div id="cartContainer">
        <!-- Здесь будут отображаться данные корзины -->
    </div>
</body>
</html>
